= TDD-Plan: Stdio Transport Support
:toc: left
:toclevels: 3
:sectnums:

== √úberblick

Implementierung von **Stdio Transport Support** f√ºr den ZDF Mediathek MCP Server. Der Server soll zwischen zwei MCP-Transports wechseln k√∂nnen: Streamable HTTP (default) und Stdio.

== Motivation

* Spring AI MCP WebFlux Server unterst√ºtzt beide Transports (aber nur einen zur Zeit)
* Streamable HTTP f√ºr Produktion und Remote-Zugriff
* Stdio f√ºr lokale Entwicklung und IDE-Integrationen
* Transport-Wahl per Umgebungsvariable ohne Code-√Ñnderungen

== Technischer Hintergrund

=== Spring AI MCP Server

Laut https://docs.spring.io/spring-ai/reference/api/mcp/mcp-stdio-sse-server-boot-starter-docs.html[Spring AI Dokumentation]:

[quote]
____
**SSE WebFlux Server**

Full MCP Server feature support with SSE (Server-Sent Events) server transport based on Spring WebFlux and an optional STDIO transport.

* **Optional STDIO transport (enabled by setting spring.ai.mcp.server.stdio=true)**
____

[IMPORTANT]
====
**Wichtige Erkenntnis aus Tests:**

Entgegen der initialen Annahme k√∂nnen **Stdio und Streamable NICHT gleichzeitig** aktiv sein.
Wenn `stdio: true` gesetzt wird, wird Streamable HTTP automatisch deaktiviert.

**L√∂sung:**
- Default: `stdio: false` (Streamable HTTP aktiv)
- Via `SPRING_AI_MCP_SERVER_STDIO=true` kann auf Stdio umgeschaltet werden
====

=== Transport-√úbersicht

[cols="1,3,3", options="header"]
|===
|Transport |Beschreibung |Use Case

|Streamable HTTP (Default)
|HTTP-Endpunkt auf Port 8080. `stdio: false`
|Produktion, Remote-Zugriff, mehrere Clients gleichzeitig, Standard

|Stdio
|stdin/stdout Kommunikation. `stdio: true`
|Lokale Entwicklung, IDE-Integrationen, Docker mit `-i` Flag
|===

[WARNING]
====
**Nur ein Transport zur Zeit aktiv!**

Wenn `stdio: true` gesetzt wird, wird Streamable HTTP automatisch deaktiviert.
====

=== Konfiguration

**Aktivierung √ºber application.yaml:**

[source,yaml]
----
spring:
  ai:
    mcp:
      server:
        enabled: true
        name: zdf-mediathek-mcp
        # Default: stdio: false (Streamable HTTP active)
        # Set SPRING_AI_MCP_SERVER_STDIO=true to switch to stdio
        stdio: false
        protocol: streamable
        streamable-http:
          mcp-endpoint: /
----

**Umschalten via Umgebungsvariable:**

[source,bash]
----
# Default: Streamable HTTP
docker run -p 8080:8080 ...

# Stdio Transport
docker run -i -e SPRING_AI_MCP_SERVER_STDIO=true ...
----

**Transport-Status:**

* Default (`stdio: false`): Streamable HTTP auf `http://localhost:8080/`
* Mit `SPRING_AI_MCP_SERVER_STDIO=true`: Stdio via stdin/stdout

== TDD-Plan

=== Phase 1: Research & Analysis (1-2 Stunden)

==== 1.1 Spring AI MCP Stdio-Dokumentation analysieren

[cols="1,3", options="header"]
|===
|Status |Aufgabe

|‚úì
|Spring AI Dokumentation gelesen: Stdio ist optional und l√§uft parallel zu HTTP

|‚òê
|MCP Client-Setup f√ºr Stdio in Tests recherchieren (`StdioServerTransport`)

|‚òê
|Pr√ºfen: Wie wird Logging bei Stdio gehandhabt? (stdout f√ºr MCP, stderr f√ºr Logs?)

|‚òê
|Beispiel-Code f√ºr Stdio Integration Tests in Spring AI suchen
|===

**Erwartetes Ergebnis:** Verst√§ndnis, wie man einen MCP Client f√ºr Stdio-Tests aufsetzt.

---

=== Phase 2: Stdio aktivieren & testen (2-3 Stunden)

==== 2.1 Stdio-Unterst√ºtzung in application.yaml konfigurieren

**Datei:** `src/main/resources/application.yaml`

[source,yaml]
----
spring:
  ai:
    mcp:
      server:
        enabled: true
        name: zdf-mediathek-mcp
        # Transport modes: streamable (HTTP) or stdio (stdin/stdout)
        # Note: Only one transport can be active at a time
        # Default: streamable (HTTP on port 8080)
        # Set SPRING_AI_MCP_SERVER_STDIO=true to use stdio transport
        protocol: streamable
        stdio: false  # ‚Üê Default: Streamable HTTP aktiv
        streamable-http:
          mcp-endpoint: /
----

**Wichtig:**
- Default bleibt `stdio: false` (Streamable HTTP)
- Umschalten auf Stdio via `SPRING_AI_MCP_SERVER_STDIO=true`
- Keine weiteren Code-√Ñnderungen n√∂tig

==== 2.2 Bestehende Tests validieren

**Validierung:** Alle bestehenden Integration Tests (die Streamable HTTP nutzen) m√ºssen weiterhin erfolgreich laufen.

[source,bash]
----
./gradlew test
----

[cols="1,3", options="header"]
|===
|Status |Ergebnis

|‚úì Green
|Alle 54 Tests laufen erfolgreich - `stdio: false` (default) funktioniert korrekt
|===

==== 2.3 Stdio Transport Integration Test

**Datei:** `src/test/kotlin/eu/wiegandt/zdfmediathekmcp/mcp/tools/SearchContentServiceStdioIT.kt`

Kopiere `SearchContentServiceIT.kt` und passe f√ºr Stdio an:

[source,kotlin]
----
package eu.wiegandt.zdfmediathekmcp.mcp.tools

// ...existing imports from SearchContentServiceIT...

@SpringBootTest(
    webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT,  // HTTP l√§uft weiter
    properties = [
        "spring.ai.mcp.client.enabled=true",
        "spring.ai.mcp.client.type=async",
        "spring.ai.mcp.server.stdio=true",  // ‚Üê Stdio aktivieren
        "zdf.client.id=test-client",
        "zdf.client.secret=test-secret"
    ]
)
@EnableWireMock(
    ConfigureWireMock(
        name = "wiremock",
        property = "zdf.url"
    )
)
class SearchContentServiceStdioIT {

    @Autowired
    private lateinit var authorizedClientService: ReactiveOAuth2AuthorizedClientService

    @Autowired
    private lateinit var objectMapper: ObjectMapper

    private lateinit var mcpClient: McpClient

    @BeforeEach
    fun setup() {
        // Setup MCP Client mit Stdio Transport
        // Nutze StdioServerTransport anstelle von WebClientStreamableHttpTransport
        // Details aus Phase 1 Research
    }

    @Test
    fun `should search content via stdio transport`() {
        // given: WireMock stub f√ºr ZDF API
        // when: Tool √ºber Stdio aufrufen
        // then: Ergebnis korrekt
    }

    @AfterEach
    fun teardown() {
        // MCP Client schlie√üen
    }
}
----

[cols="1,3", options="header"]
|===
|Status |Beschreibung

|Red
|Test schl√§gt fehl, weil Stdio-Client-Setup noch fehlt

|Green
|Test l√§uft erfolgreich mit Stdio-Transport

|Refactor
|Test-Code aufr√§umen
|===

---

=== Phase 3: Dokumentation (1 Stunde)

==== 3.1 application.yaml kommentieren

**Datei:** `src/main/resources/application.yaml`

Kommentar hinzuf√ºgen:

[source,yaml]
----
spring:
  ai:
    mcp:
      server:
        enabled: true
        name: zdf-mediathek-mcp
        # Enable stdio transport parallel to streamable-http
        # Clients can connect via HTTP or stdin/stdout simultaneously
        stdio: true
        streamable-http:
          mcp-endpoint: /
----

==== 3.2 README aktualisieren

**Datei:** `README.md`

**√Ñnderungen:**

1. Transport-Status von "Planned" zu "Available" √§ndern
2. Klarstellen, dass **beide Transports parallel** laufen
3. Docker-Beispiele m√ºssen **nicht** ge√§ndert werden:
   * Stdio funktioniert automatisch mit `docker run -i` wenn `stdio: true` in application.yaml
   * Keine zus√§tzliche Umgebungsvariable n√∂tig

**Aktualisierung im Overview:**

[source,markdown]
----
**Transport Support:** Supports both Streamable HTTP and Stdio transport simultaneously.

### Key Features
- üåê **Dual Transport**: Streamable HTTP (production) and Stdio (local dev) run in parallel
----

**Aktualisierung in "MCP Transport Types" Sektion:**

[source,markdown]
----
### MCP Transport Types

This server supports **both transports simultaneously**:

#### 1. Streamable HTTP Transport
Always active when server runs.
...

#### 2. Stdio Transport
Also active - automatically used when Docker container runs with `-i` flag.
...
----

[NOTE]
====
Die bestehenden Docker-Konfigurationen in der README sind bereits korrekt!
Stdio funktioniert automatisch, da es jetzt in `application.yaml` aktiviert ist.
====

==== 3.3 AGENTS.md aktualisieren

**Datei:** `AGENTS.md`

Sektion "Architecture Decisions" erg√§nzen:

[source,markdown]
----
### MCP Dual Transport Support

**Decision:** Enable both Streamable HTTP and Stdio transports simultaneously

**Rationale:**
- Spring AI MCP WebFlux Server supports both transports in parallel
- No need to choose - users can use HTTP or Stdio based on their use case
- Streamable HTTP: Better for production, remote access, multiple clients
- Stdio: Better for local development, IDE integrations, simpler Docker setup

**Implementation:**
- Set `spring.ai.mcp.server.stdio: true` in application.yaml
- Both transports active by default
- No code changes needed - Spring AI handles everything
- Docker configurations unchanged - stdio works automatically with `-i` flag

**Testing:**
- Both transports tested via integration tests
- `SearchContentServiceIT.kt` for Streamable HTTP
- `SearchContentServiceStdioIT.kt` for Stdio

**Benefits:**
- Maximum flexibility for users
- Backward compatible (HTTP still works as before)
- Simpler than switching between transports
----

== Zusammenfassung der √Ñnderungen

[cols="2,4,1", options="header"]
|===
|Datei |√Ñnderung |Komplexit√§t

|`application.yaml`
|`stdio: true` hinzuf√ºgen
|Trivial (1 Zeile)

|`SearchContentServiceStdioIT.kt`
|Neuer Integration Test
|Mittel

|`README.md`
|Transport-Status aktualisieren
|Niedrig

|`AGENTS.md`
|Architecture Decision dokumentieren
|Niedrig
|===

[NOTE]
====
**Keine √Ñnderungen n√∂tig:**

* Docker-Konfigurationen (funktionieren bereits mit Stdio)
* Bestehende Integration Tests
* MCP Tool-Implementierungen
* Build-Konfiguration
====

== Test-√úbersicht

[cols="2,4,1", options="header"]
|===
|Test-Datei |Zweck |Phase

|`SearchContentServiceStdioIT.kt`
|Stdio Transport Integration Test
|2.3
|===

[NOTE]
====
Nur ein zus√§tzlicher Integration Test n√∂tig. Die bestehenden HTTP-Tests bleiben unver√§ndert.
====

== Akzeptanzkriterien

[cols="1,4", options="header"]
|===
|Status |Kriterium

|‚úì
|README dokumentiert beide Transport-Typen

|‚úì
|`spring.ai.mcp.server.stdio: false` in application.yaml (default) mit Kommentaren

|‚úì
|Integration Test `SearchContentServiceStdioIT.kt` l√§uft erfolgreich

|‚úì
|Alle bestehenden Tests (Streamable HTTP) laufen weiterhin durch (55 Tests)

|‚úì
|Beide Transports funktionieren (nur einer zur Zeit aktiv)

|‚úì
|Docker mit `SPRING_AI_MCP_SERVER_STDIO=true` aktiviert Stdio

|‚úì
|README aktualisiert: Transport-Status dokumentiert, nicht mehr "Planned"

|‚úì
|AGENTS.md mit Architecture Decision erg√§nzt

|‚úì
|Kommentare in application.yaml hinzugef√ºgt
|===

== Offene Fragen (Phase 1)

1. Wie wird der MCP Client f√ºr Stdio in Tests aufgesetzt? (`StdioServerTransport` Beispiele finden)
2. Werden Logs bei Stdio anders behandelt? (stdout f√ºr MCP, stderr f√ºr Logs?)
3. Gibt es Spring AI MCP Beispiel-Code f√ºr Stdio Integration Tests?

== Risiken & Mitigationen

[cols="3,1,1,3", options="header"]
|===
|Risiko |Wahrscheinlichkeit |Impact |Mitigation

|MCP Client-Setup f√ºr Stdio in Tests unklar
|Mittel
|Mittel
|Phase 1: Beispiele in Spring AI suchen

|Logging-Konflikte (stdout)
|Niedrig
|Niedrig
|Logging auf stderr umleiten

|Bestehende Tests brechen
|Sehr Niedrig
|Hoch
|Alle Tests nach √Ñnderungen ausf√ºhren
|===

== Zeitsch√§tzung

[cols="1,2", options="header"]
|===
|Phase |Zeit

|Phase 1 (Research)
|1-2 Stunden

|Phase 2 (Implementierung & Tests)
|2-3 Stunden

|Phase 3 (Dokumentation)
|1 Stunde

|**Gesamt**
|**4-6 Stunden**
|===

[NOTE]
====
Drastisch reduziert durch parallele Transport-Unterst√ºtzung!
Urspr√ºngliche Sch√§tzung war 8-12 Stunden f√ºr sequenzielle Transports.
====

== Next Steps

=== 1. Phase 1 starten: Research

* Spring AI MCP Stdio-Client-Setup recherchieren
* Wie funktioniert `StdioServerTransport` in Tests?
* Gibt es Spring AI Beispiele f√ºr Stdio Integration Tests?

=== 2. Phase 2 umsetzen: Implementation

* `stdio: true` in application.yaml setzen
* Alle Tests ausf√ºhren (sollten weiterhin laufen)
* `SearchContentServiceStdioIT.kt` erstellen und zum Laufen bringen

=== 3. Phase 3 abschlie√üen: Dokumentation

* README und AGENTS.md aktualisieren
* Kommentare in application.yaml hinzuf√ºgen

=== 4. Manueller Test

* Docker mit `docker run -i` testen
* Claude Desktop / VS Code / IntelliJ mit Stdio-Config testen

== Vorteile dieser L√∂sung

[cols="1,3", options="header"]
|===
|Vorteil |Beschreibung

|‚úì Drastisch einfacher
|Keine Auswahl zwischen Transports, keine Umgebungsvariablen zum Umschalten, nur eine Property: `stdio: true`

|‚úì Maximale Flexibilit√§t
|HTTP-Clients funktionieren wie bisher, Stdio-Clients parallel, keine Breaking Changes

|‚úì Minimaler Aufwand
|1 Zeile in application.yaml, 1 neuer Integration Test, Dokumentation, Fertig!

|‚úì Perfekt f√ºr alle Use Cases
|Produktion (HTTP), Entwicklung (Stdio), beides gleichzeitig nutzbar
|===

[IMPORTANT]
====
**Killer-Features:**

* üéØ Zero Breaking Changes - HTTP funktioniert exakt wie bisher
* üéØ Maximum Flexibility - Beide Transports parallel nutzbar
* üéØ Minimal Effort - 1 Zeile Code + 1 Test + Doku
* üéØ Perfect f√ºr alle - Produktion (HTTP) + Entwicklung (Stdio) gleichzeitig
====

